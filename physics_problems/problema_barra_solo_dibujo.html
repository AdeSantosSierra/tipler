<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba Scrolling - Problema Barra</title>
    <style>
        :root {
            --bg-color: #272822;
            /* Monokai Background */
            --text-color: #f8f8f2;
            --accent-green: #e6db74;
            --box-bg: #1e1f1a;
            --box-border: #49483e;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            /* Wider sidebar for test */
            gap: 3rem;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
        }

        .sidebar {
            position: sticky;
            top: 2rem;
            align-self: start;
            height: fit-content;
        }

        .content-scroll {
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            padding-bottom: 50vh;
            /* Extra space at bottom */
        }

        .section {
            background: var(--box-bg);
            border: 1px solid var(--box-border);
            padding: 2rem;
            border-radius: 8px;
        }

        h2 {
            color: var(--accent-green);
            margin-top: 0;
        }

        p {
            line-height: 1.6;
            color: #ccc;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }

        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
    </style>
</head>

<body>

    <div class="main-layout">
        <!-- Sidebar with Single Interactive Frame -->
        <div class="sidebar">
            <div
                style="width: 100%; height: 600px; position: sticky; top: 20px; border: 1px solid var(--box-border); border-radius: 4px;">
                <iframe id="viz-iframe" src="final_interactive.html?v=110"
                    style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
            <p style="text-align: center; font-size: 0.9em; opacity: 0.7; margin-top: 10px;">
                 Haz scroll para ver el elemento diferencial de fuerza.
            </p>
        </div>

        <!-- Long Scrollable Content -->
        <div class="content-scroll">
            <div class="section">
                <h2>Secuencia de Animaci贸n</h2>
                <p><strong>Fase 1 (Inicio):</strong> Planteamiento del Problema.</p>
                <p><strong>Fase 2 (Scroll):</strong> Aparece todo el Campo El茅ctrico.</p>
                <p><strong>Fase 3 (M谩s Scroll):</strong> Aparece la Superficie Gaussiana.</p>
                <p><strong>Fase 4 (Secci贸n 12):</strong> Proyecci贸n en el plano positivo XY.</p>
                <p><strong>Fase 5 (Secci贸n 20):</strong> Elemento Diferencial. La barra se "aten煤a" (no desaparece) para
                    resaltar un diferencial de carga <strong>dq</strong>.</p>
            </div>

            <!-- Generate 40 Lorem Ipsum Sections -->
            <script>
                const contentDiv = document.querySelector('.content-scroll');
                const lorem = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.";

                for (let i = 1; i <= 40; i++) {
                    const section = document.createElement('div');
                    section.className = 'section';
                    section.innerHTML = `
                        <h2>Secci贸n ${i}</h2>
                        <p>${lorem}</p>
                        <p>${lorem}</p>
                    `;
                    contentDiv.appendChild(section);
                }
            </script>
        </div>
    </div>

    <!-- Scroll Listener Script -->
    <script>
        window.addEventListener('scroll', function () {
            const iframe = document.getElementById('viz-iframe');
            if (!iframe || !iframe.contentWindow) return;

            const doc = document.documentElement;
            const scrollTop = window.pageYOffset || doc.scrollTop;
            const docHeight = doc.scrollHeight - doc.clientHeight;

            if (docHeight <= 0) return;

            const scrollPercent = scrollTop / docHeight;

            let fieldPosOpacity = 0;
            let fieldNegOpacity = 0;
            let fieldOutOpacity = 0;
            let cylOpacity = 0;
            let barOpacity = 1.0; // Default Visible
            let dqOpacity = 0;

            // Updated Ranges with Differential Phase
            // 0% - 10%: Geometry Only
            // 10% - 30%: ALL Field appears
            // 30% - 40%: Cylinder appears
            // 40% - 60%: Projection Mode (Only Pos Y Field, Cyl Gone)
            // > 60% (Section 20 approx): Differential Mode (Bar dims to 0.2, dq appears)

            // Base Calculation (Normal Mode)
            if (scrollPercent > 0.10) {
                let t = (scrollPercent - 0.10) / 0.20;
                let fVal = Math.min(Math.max(t, 0), 1) * 0.8;
                fieldPosOpacity = fVal;
                fieldNegOpacity = fVal;
                fieldOutOpacity = fVal;
            }

            if (scrollPercent > 0.30) {
                let t = (scrollPercent - 0.30) / 0.10;
                cylOpacity = Math.min(Math.max(t, 0), 1) * 1.0;
            }

            // Abrupt Cutoff Logic (Section 12 ~ 40%)
            if (scrollPercent > 0.40) {
                fieldOutOpacity = 0.0; // Abrupt Kill (Out of Plane)
                fieldNegOpacity = 0.0; // Abrupt Kill (Neg Y)
                cylOpacity = 0.0;      // Abrupt Kill (Cylinder)
                // fieldPosOpacity stays at 0.8
            }

            // Differential Logic (Section 20 ~ 55-65%)
            // Let's fade bar out partially (to 0.2) and dq in between 55% and 65%
            if (scrollPercent > 0.55) {
                let t = (scrollPercent - 0.55) / 0.10; // 0 to 1 over 55-65%
                t = Math.min(Math.max(t, 0), 1);

                // Bar fades out partially (to 0.2)
                // 1.0 -> 0.2 implies a change of 0.8 * t
                barOpacity = 1.0 - (0.8 * t);

                // dq fades in
                dqOpacity = t;
            }

            iframe.contentWindow.postMessage({
                type: 'scroll',
                fieldPosOpacity: fieldPosOpacity,
                fieldNegOpacity: fieldNegOpacity,
                fieldOutOpacity: fieldOutOpacity,
                cylOpacity: cylOpacity,
                barOpacity: barOpacity,
                dqOpacity: dqOpacity
            }, '*');
        }, { passive: true });

        // Trigger once on load
        window.setTimeout(() => window.dispatchEvent(new Event('scroll')), 500);
    </script>
</body>

</html>