---
import PhysicsProblemTemplate from '../components/master/PhysicsProblemTemplate.astro';
import StepBox from '../components/StepBox.astro';
import { symbols, cylindricalFlux, cylindricalTotalCharge, cylindricalTotalFieldMag, withTooltip } from '../lib/physics-math';

// Problem Data
const apartados = [
  { id: 'apartado-a', label: 'Apartado A', active: true },
  { id: 'apartado-b', label: 'Apartado B' }
];

// Math constants and strings using the library
export const math = {
    sigma1: symbols.sigma(1),
    sigma2: symbols.sigma(2),
    R1: symbols.R(1),
    R2: symbols.R(2),
    r: symbols.r,
    E: symbols.E,
    vecE: symbols.vecE,
    
    // Step 1: r < R1
    step1_cond: String.raw`${symbols.r} < ${symbols.R(1)}`,
    step1_qenc: String.raw`Q_{\text{enc}} = 0`,
    step1_note: `Las cortezas cilíndricas son huecas — no existe carga en su interior. Cualquier superficie gaussiana con $ r < R_1 $ no encierra carga neta.`,
    step1_eq: String.raw`
        ${symbols.integralGauss} = \frac{Q_{\text{enc}}}{\varepsilon_0} = 0 \\
        ${symbols.vecE} = 0 \quad \left[\frac{\text{N}}{\text{C}}\right]`,
        
    // Step 2: R1 < r < R2
    step2_cond: String.raw`${symbols.R(1)} < ${symbols.r} < ${symbols.R(2)}`,
    step2_flujo: String.raw`
        \oint_S \vec{E} \cdot d\vec{S}
            = \oint_S E \, dS
            = E \oint_S dS
            = ${withTooltip(cylindricalFlux(), 'math-term-source-flujo')}`,
    step2_carga: String.raw`Q_{\text{enc}} = ${cylindricalTotalCharge([{ sigma: symbols.sigma(1), R: symbols.R(1) }])}`,
    step2_resultado: String.raw`
        ${withTooltip(cylindricalFlux(), 'math-term-target-flujo-A flux-hover flux-box-target')} = \frac{\sigma_1 (2\pi R_1 L)}{\varepsilon_0} \\
        ${symbols.vecE} = ${cylindricalTotalFieldMag([{ sigma: symbols.sigma(1), R: symbols.R(1) }])} ${symbols.ur}
            \left[\frac{\text{N}}{\text{C}}\right]`,

    // Step 3: r > R2
    step3_cond: String.raw`${symbols.r} > ${symbols.R(2)}`,
    step3_qenc: String.raw`Q_{\text{enc}} = ${cylindricalTotalCharge([{ sigma: symbols.sigma(1), R: symbols.R(1) }, { sigma: symbols.sigma(2), R: symbols.R(2) }])}`,
    step3_resultado: String.raw`
        ${withTooltip(cylindricalFlux(), 'math-term-target-flujo-B flux-hover flux-box-target')} = \frac{2\pi L (\sigma_1 R_1 + \sigma_2 R_2)}{\varepsilon_0} \\
        ${symbols.vecE} = ${cylindricalTotalFieldMag([{ sigma: symbols.sigma(1), R: symbols.R(1) }, { sigma: symbols.sigma(2), R: symbols.R(2) }])} ${symbols.ur}
            \left[\frac{\text{N}}{\text{C}}\right]`,

    // Apartado B: E = 0 for r > R2
    stepB_cond: String.raw`${symbols.vecE} = 0 \text{ para } ${symbols.r} > ${symbols.R(2)}`,
    stepB_start: String.raw`
        ${symbols.vecE}(r) = \begin{cases} 
        0 & ${symbols.r} < ${symbols.R(1)} \\
        ${cylindricalTotalFieldMag([{ sigma: symbols.sigma(1), R: symbols.R(1) }])} ${symbols.ur} & ${symbols.R(1)} < ${symbols.r} < ${symbols.R(2)} \\
        ${cylindricalTotalFieldMag([{ sigma: symbols.sigma(1), R: symbols.R(1) }, { sigma: symbols.sigma(2), R: symbols.R(2) }])} ${symbols.ur} & ${symbols.r} > ${symbols.R(2)}
        \end{cases}`,
    stepB_focus: String.raw`${symbols.vecE} = \frac{${withTooltip(`${symbols.sigma(1)} ${symbols.R(1)} + ${symbols.sigma(2)} ${symbols.R(2)}`, 'numerador-tooltip-target')}}{\varepsilon_0 r} ${symbols.ur} = 0`,
    stepB_ratio_eq: String.raw`
        ${symbols.sigma(1)} ${symbols.R(1)} + ${symbols.sigma(2)} ${symbols.R(2)} = 0 \\
        ${symbols.sigma(1)} ${symbols.R(1)} = -${symbols.sigma(2)} ${symbols.R(2)} \\
        \frac{${symbols.sigma(2)}}{${symbols.sigma(1)}} = -\frac{${symbols.R(1)}}{${symbols.R(2)}}`,
    stepB_E_between: String.raw`${symbols.vecE} = \frac{${symbols.sigma(1)} ${symbols.R(1)}}{\varepsilon_0 r} ${symbols.ur} = -\frac{${symbols.sigma(2)} ${symbols.R(2)}}{\varepsilon_0 r} ${symbols.ur} \quad \left[\frac{\text{N}}{\text{C}}\right]`,

    // Conclusions
    conclusions: String.raw`
        ${symbols.vecE}(r) = \begin{cases} 
        0 & ${symbols.r} < ${symbols.R(1)} \\
        ${cylindricalTotalFieldMag([{ sigma: symbols.sigma(1), R: symbols.R(1) }])} ${symbols.ur} & ${symbols.R(1)} < ${symbols.r} < ${symbols.R(2)} \\
        ${cylindricalTotalFieldMag([{ sigma: symbols.sigma(1), R: symbols.R(1) }, { sigma: symbols.sigma(2), R: symbols.R(2) }])} ${symbols.ur} & ${symbols.r} > ${symbols.R(2)}
        \end{cases}`
};
---

<PhysicsProblemTemplate title="Problema 3: Cortezas Cilíndricas" apartados={apartados}>
    <div slot="header" class="problem-header">
    </div>

    <StepBox slot="statement" label="Enunciado del Problema" vizSrc="/generic_cylindrical_viewer.html?hideGauss=true" vizId="viz-step-0">
        <div class="step-content">
            <div class="step-text-col" style="flex: 1; border: none; text-align: left; color: white;">
                <p>Consideremos dos cortezas cilíndricas concéntricas infinitamente largas.</p>
                <p style="margin-top: 0.5rem;">La corteza interior tiene radio {`$ ` + math.R1 + ` $`} y densidad superficial {`$ ` + math.sigma1 + ` $`}. La exterior tiene radio {`$ ` + math.R2 + ` $`} y densidad superficial {`$ ` + math.sigma2 + ` $`}.</p>
                <div style="margin-top: 1rem; color: #cfcfc2;">
                    <p>(a) Utilizar la Ley de Gauss para hallar el campo eléctrico en las tres regiones.</p>
                    <p style="margin-top: 0.5rem;" set:html={`(b) ¿Cuál deberá ser el cociente $ \\frac{\\sigma_2}{\\sigma_1} $ y el signo relativo de ambas para que \( \vec{E} \) sea nulo en $r > R_2$? ¿Cuál es entonces el campo eléctrico entre las cortezas?`} />
                </div>
            </div>
        </div>
    </StepBox>

    <div id="apartado-a" class="apartado-section active">
        <StepBox label={String.raw`Paso 1: Cálculo de $ \vec{E} $ para $ r < R_1 $`}>
            <div class="step-content-wrapper">
                <div class="step-viz-col">
                    <iframe src="/generic_cylindrical_viewer.html?r=0.65" class="viz-frame" id="viz-step-1" scrolling="no" style="width: 100%; height: 400px; border: none; border-radius: 8px;"></iframe>
                </div>
                <div class="step-text-math-col">
                    <div class="step-content">
                        <div class="step-text-col" style="color: #cfcfc2; border-right: 1px dashed #75715e; padding-right: 2.5rem; text-align: right;">
                            <p>Para un radio {`$ ` + math.r + ` $`} menor que {`$ ` + math.R1 + ` $`}, la superficie gaussiana no encierra ninguna carga.</p>
                        </div>
                        <div class="step-math-col">
                            <div class="qenc-tooltip-container">
                                <div class="qenc-red-box-centered">
                                    <div set:html={String.raw`$$ ${math.step1_qenc} $$`} />
                                    <div class="qenc-tooltip-content">
                                        {math.step1_note}
                                    </div>
                                </div>
                            </div>
                            <div style="font-size: 1.1em; overflow-x: auto;" set:html={String.raw`$$ \begin{align*} ${math.step1_eq} \end{align*} $$`} />
                        </div>
                    </div>
                </div>
            </div>
        </StepBox>

        <StepBox label={String.raw`Paso 2: Cálculo de $ \vec{E} $ para $ R_1 < r < R_2 $`}>
            <div class="step-content-wrapper">
                <div class="step-viz-col">
                    <iframe src="/generic_cylindrical_viewer.html?r=1.7" class="viz-frame" id="viz-step-2" scrolling="no" style="width: 100%; height: 400px; border: none; border-radius: 8px;"></iframe>
                </div>
                <div class="step-text-math-col" style="padding: 0;">
                    <div class="paso2-section">
                        <div class="paso2-comment">
                            <p>Por simetría cilíndrica, {`$ ` + math.E + ` $`} es constante y perpendicular en toda la superficie gaussiana, por lo que podemos extraerla de la integral.</p>
                        </div>
                        <div class="paso2-math">
                            <div style="font-size: 1.05em; overflow-x: auto;" set:html={String.raw`$$ \begin{align*} ${math.step2_flujo} \end{align*} $$`} />
                        </div>
                    </div>

                    <div class="paso2-section">
                        <div class="paso2-comment">
                            <p>La carga encerrada es únicamente la de la corteza interior de radio {`$ ` + math.R1 + ` $`}.</p>
                        </div>
                        <div class="paso2-math" style="display: flex; justify-content: center;">
                            <div class="qenc-tooltip-container-inline">
                                <div class="qenc-red-box-simple">
                                    <div style="font-size: 1.05em; overflow-x: auto;" set:html={`$$ ${math.step2_carga} $$`} />
                                    <div class="qenc-tooltip-content">
                                        El término entre paréntesis representa el área lateral del cilindro de radio \(R_1\) y longitud \(L\).
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="paso2-section" style="border-bottom: none;">
                        <div class="paso2-comment">
                            <p set:html={`Igualamos los términos anteriores. El campo resultante decae con $ \\frac{1}{r} $ y apunta en dirección radial.`} />
                        </div>
                        <div class="paso2-math">
                            <div style="font-size: 1.05em; overflow-x: auto;" set:html={String.raw`$$ \begin{align*} ${math.step2_resultado} \end{align*} $$`} />
                        </div>
                    </div>
                </div>
            </div>
        </StepBox>

        <StepBox label={String.raw`Paso 3: Cálculo de $ \vec{E} $ para $ r > R_2 $`}>
            <div class="step-content-wrapper">
                <div class="step-viz-col">
                    <iframe src="/generic_cylindrical_viewer.html?r=2.8" class="viz-frame" id="viz-step-3" scrolling="no" style="width: 100%; height: 400px; border: none; border-radius: 8px;"></iframe>
                </div>
                <div class="step-text-math-col">
                    <div class="step-content">
                        <div class="step-text-col" style="color: #cfcfc2; border-right: 1px dashed #75715e; padding-right: 2.5rem; text-align: right;">
                            <p>La superficie gaussiana encierra a ambas cortezas. La carga total encerrada es la suma de ambas.</p>
                        </div>
                        <div class="step-math-col" style="align-items: center; gap: 0.5rem;">
                            <div class="qenc-tooltip-container-inline">
                                <div class="qenc-red-box-simple">
                                    <div style="font-size: 1.1em; overflow-x: auto;" set:html={String.raw`$$ ${math.step3_qenc} $$`} />
                                    <div class="qenc-tooltip-content" style="width: 250px;">
                                        Puede verse como Qenc del primer conductor y Qenc del segundo.
                                    </div>
                                </div>
                            </div>
                            <div style="font-size: 1.1em; overflow-x: auto; width: 100%; display: flex; justify-content: center;" set:html={String.raw`$$ \begin{align*} ${math.step3_resultado} \end{align*} $$`} />
                        </div>
                    </div>
                </div>
            </div>
        </StepBox>

        <StepBox label="Conclusiones: Expresión del Campo Eléctrico">
            <div class="step-content-wrapper">
                <div class="step-text-math-col" style="padding: 0;">
                    <div class="paso2-section" style="border-bottom: none;">
                        <div class="paso2-comment" style="color: #f8f8f2;">
                            <p>Resumen del campo eléctrico en todas las regiones del espacio:</p>
                        </div>
                        <div class="paso2-math">
                            <div style="font-size: 1.4em; color: white;" set:html={String.raw`$$ ${math.conclusions} $$`} />
                        </div>
                    </div>
                </div>
            </div>
        </StepBox>
    </div>

    <div id="apartado-b" class="apartado-section">
        <StepBox label={String.raw`Paso 1: Cálculo del cociente de densidades`}>
            <div class="derivation-container" style="padding: 1rem 0;">
                <div class="derivation-row">
                    <div class="derivation-col-left">
                        <p>Partimos del campo eléctrico calculado anteriormente:</p>
                    </div>
                    <div class="derivation-col-right">
                        <div style="font-size: 1.1em; width: 100%;" set:html={String.raw`$$ ${math.stepB_start} $$`} />
                    </div>
                </div>

                <div class="derivation-row">
                    <div class="derivation-col-left">
                        <p>Nos centramos en la región exterior {`$ r > R_2 $`} donde buscamos que el campo sea nulo:</p>
                    </div>
                    <div class="derivation-col-right">
                        <div class="numerador-tooltip-container">
                            <div style="font-size: 1.1em; width: 100%;" set:html={String.raw`$$ ${math.stepB_focus} $$`} />
                            <div class="numerador-tooltip-content">
                                Para que se cumpla la condición de campo nulo, solo el numerador tiene que ser cero.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="derivation-row">
                    <div class="derivation-col-left">
                        <p>Igualamos el numerador a cero para anular la expresión. Resolviendo para el cociente de densidades obtenemos la condición necesaria:</p>
                    </div>
                    <div class="derivation-col-right">
                        <div style="font-size: 1.1em; width: 100%;" set:html={String.raw`$$ \begin{align*} ${math.stepB_ratio_eq} \end{align*} $$`} />
                    </div>
                </div>

                <div class="derivation-row" style="margin-bottom: 0;">
                    <div class="derivation-col-left">
                        <p set:html={`En estas condiciones, el campo eléctrico entre las cortezas $ (R_1 < r < R_2) $ se puede expresar en función de ambas densidades:`} />
                    </div>
                    <div class="derivation-col-right">
                        <div style="font-size: 1.1em; width: 100%;" set:html={String.raw`$$ ${math.stepB_E_between} $$`} />
                    </div>
                </div>
            </div>
        </StepBox>
    </div>
</PhysicsProblemTemplate>

<script is:inline>
    // Local Equation Linking Logic (Specific to this problem's terms)
    document.addEventListener('DOMContentLoaded', () => {
        function initEquationLinking() {
            if (!window.LeaderLine) return;
            const source = document.querySelector('.math-term-source-flujo');
            const targetA = document.querySelector('.math-term-target-flujo-A');
            const targetB = document.querySelector('.math-term-target-flujo-B');
            
            if (!source) return;

            const setupLine = (target, color) => {
              if (!target) return null;
              let line = null;
              target.addEventListener('mouseenter', () => {
                if (target.offsetParent !== null) {
                  line = new LeaderLine(source, target, {
                    color: color, size: 3, path: 'grid', 
                    startSocket: 'right', endSocket: 'right',
                    startPlug: 'disc', endPlug: 'arrow3',
                    dash: { animation: true }
                  });
                  line.setOptions({ zIndex: 10000 });
                }
              });
              target.addEventListener('mouseleave', () => { if (line) { line.remove(); line = null; } });
              return line;
            };

            setupLine(targetA, '#a6e22e');
            setupLine(targetB, '#a6e22e');
        }

        if (window.MathJax && window.MathJax.startup) {
            window.MathJax.startup.promise.then(() => setTimeout(initEquationLinking, 500));
        } else {
            setTimeout(initEquationLinking, 1500);
        }
    });
</script>
