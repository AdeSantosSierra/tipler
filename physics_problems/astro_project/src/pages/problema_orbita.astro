---
import Layout from '../layouts/Layout.astro';
import StepBox from '../components/StepBox.astro';

const math = {
    lambda: String.raw`\(\lambda\)`,
    mass: String.raw`\(m\)`,
    q: String.raw`\(q\)`,
    R: String.raw`\(R\)`,
    
    step1_E_vec: String.raw`\(\vec{E}\)`,
    step1_S: String.raw`\(S\)`,
    step1_r: String.raw`\(r\)`,
    step1_Lp: String.raw`\(L'\)`,
    step1_flux_eq: String.raw`
        \begin{align*}
        \oint_S \vec{E} \cdot d\vec{S} &= \oint_S E dS = E \oint_S dS =
        \class{math-term-source-2}{E (2\pi r L')}
        \end{align*}`,
    step1_lambda_units: String.raw`\(\lambda\)`,
    step1_Qm: String.raw`\(\frac{Q}{m}\)`,
    step1_Qenc_eq: String.raw`
        \begin{align*}
        \mathrm{Q}_{\text{enc}} &= \class{math-term-source}{\lambda L'}
        \end{align*}`,
    step1_gauss_E: String.raw`\(E\)`,
    step1_gauss_eq: String.raw`
        \begin{align*}
        \class{math-term-target-2}{\bbox[4px,border:1px dashed
        #a6e22e;border-radius:8px,#272822]{E (2\pi r L')}} &=
        \frac{\class{math-term-target}{\bbox[4px,border:1px dashed
        #f92672;border-radius:8px,#272822]{\lambda L'}}}{\varepsilon_0} \\[10pt]
        E &= \frac{\lambda}{2\pi \varepsilon_0 r} \quad
        \left[\frac{\unit{N}}{\unit{C}}\right]
        \end{align*}`,
    step1_final_eq: String.raw`
        \begin{align*}
        \vec{E} &= \frac{\lambda}{2\pi \varepsilon_0} \class{hover-trigger radial-tooltip}{\bbox[4px,border:1px dashed
        #f92672;border-radius:8px,#3d292e]{\frac{\vec{u}_r}{r}}} \quad
        \left[\frac{\unit{N}}{\unit{C}}\right]
        \end{align*}`,
    
    // Tooltips
    gauss_tooltip_eq: String.raw`$$ \oint \vec{E} \cdot d\vec{S} = \frac{Q_{\text{enc}}}{\varepsilon_0} $$`,
    radial_tooltip_text: String.raw`Ponemos $\vec{u}_r$ porque el campo es radial`,
    step1_Lp_tooltip_text: String.raw`Esta longitud es la de la superficie gaussiana (cilindro imginario).`,
    
    step2_Fe: String.raw`\(F_e\)`,
    step2_Fc: String.raw`\(F_c\)`,
    step2_eq: String.raw`
        \begin{align*}
        F_e &= F_c \\[10pt]
        |q| E &= m \omega^2 R \\[10pt]
        \frac{|q|\lambda}{2\pi \varepsilon_0 R} &= m \omega^2 R
        \end{align*}`,

    step3_T: String.raw`\(T\)`,
    step3_eq: String.raw`
        \begin{align*}
        \omega^2 &= \frac{|q|\lambda}{2\pi \varepsilon_0 m R^2} \\[10pt]
        \left( \frac{2\pi}{T} \right)^2 &= \frac{|q|\lambda}{2\pi \varepsilon_0 m R^2}
        \end{align*}`,

    final_result: String.raw`
        \begin{align*}
        T &= 2\pi R \sqrt{ \frac{2\pi \varepsilon_0 m}{|q|\lambda} } \quad [\mathrm{s}]
        \end{align*}`,
};
---

<Layout title="Problema Órbita - Física">
    <div class="main-layout">
        <div class="content-scroll">
            
            <StepBox label="Enunciado del Problema" vizSrc="/orbit_interactive.html" vizId="viz-step-0">
                <div class="step-content">
                    <div class="step-text-col" style="flex: 1; border: none; text-align: left; color: white;">
                        <p>Una carga lineal infinita {math.lambda} está localizada a lo largo del eje Z.</p>
                        <p style="margin-top: 0.5rem;">Una masa {math.mass} que posee una carga {math.q} minúscula de signo opuesto al de {math.lambda}, 
                        se encuentra en una órbita circular en el plano XY alrededor de la carga lineal.</p>
                        <p style="margin-top: 0.5rem;">Deducir una expresión para el periodo de la órbita en función de {math.mass}, {math.q}, {math.R} y {math.lambda}, 
                        en donde {math.R} es el radio de la órbita.</p>
                    </div>
                </div>
            </StepBox>

            <StepBox label="Paso 1: Calcular Campo Eléctrico" vizSrc="/infinite_field.html" vizId="viz-step-1">
                <!-- 1. Flux Integral -->
                <div class="step-content">
                    <div class="step-text-col text-yellow-theme">
                        <p>Calcula el flujo del campo Eléctrico ({math.step1_E_vec}) que atraviesa la superficie
                            gaussiana {math.step1_S} (de radio {math.step1_r} y longitud <span class="hover-trigger Lp-tooltip" style="border-bottom: 1px dashed var(--accent-red); cursor: help;">{math.step1_Lp}</span>).</p>
                    </div>
                    <div class="step-math-col">
                        <div style="font-size: 1.1em; overflow-x: auto;" set:html={math.step1_flux_eq} />
                    </div>
                </div>

                <!-- 2. Enclosed Charge -->
                <div class="step-content">
                    <div class="step-text-col text-yellow-theme">
                        <p>Las unidades de {math.step1_lambda_units} son {math.step1_Qm}.</p>
                    </div>
                    <div class="step-math-col">
                        <div style="font-size: 1.1em; overflow-x: auto;" set:html={math.step1_Qenc_eq} />
                    </div>
                </div>

                <!-- 3. Gauss Law Relation & Scalar Result -->
                <div class="step-content">
                    <div class="step-text-col text-yellow-theme">
                        <p>Según la <span class="hover-trigger" data-tooltip="tooltip-gauss" style="border-bottom: 1px dashed var(--accent-red); cursor: help;">Ley de Gauss</span>, podemos relacionar ambas expresiones y despejar {math.step1_gauss_E}.</p>
                    </div>
                    <div class="step-math-col">
                        <div style="font-size: 1.1em; overflow-x: auto;" set:html={math.step1_gauss_eq} />
                    </div>
                </div>

                <!-- 4. Vector Result -->
                <div class="step-content">
                    <div class="step-text-col text-yellow-theme">
                        <p>Finalmente:</p>
                    </div>
                    <div class="step-math-col">
                        <div style="font-size: 1.1em; overflow-x: auto;" set:html={math.step1_final_eq} />
                    </div>
                </div>
            </StepBox>

            <StepBox label="Paso 2: Dinámica de Fuerzas" vizSrc="about:blank" vizId="viz-step-2">
                <div class="step-content">
                    <div class="step-text-col text-yellow-theme">
                        <p>Para que la masa describa una órbita circular, la fuerza eléctrica de atracción {math.step2_Fe} debe actuar como la fuerza centrípeta {math.step2_Fc} necesaria.</p>
                    </div>
                    <div class="step-math-col">
                        <div style="font-size: 1.1em; overflow-x: auto;" set:html={math.step2_eq} />
                    </div>
                </div>
            </StepBox>

            <StepBox label="Paso 3: Calcular el Periodo" vizSrc="about:blank" vizId="viz-step-3">
                <div class="step-content">
                    <div class="step-text-col text-yellow-theme">
                        <p>Relacionamos la velocidad angular $\omega$ con el periodo {math.step3_T} mediante la expresión $\omega = 2\pi / T$ y despejamos:</p>
                    </div>
                    <div class="step-math-col">
                        <div style="font-size: 1.1em; overflow-x: auto;" set:html={math.step3_eq} />
                    </div>
                </div>
            </StepBox>

            <StepBox label="Resultados y Conclusiones">
                <div class="step-content">
                    <div class="step-math-col">
                        <div style="font-size: 1.1em; overflow-x: auto; text-align: center;" set:html={math.final_result} />
                    </div>
                </div>
                <div class="step-content" style="margin-top: 2rem;">
                    <div style="flex: 1; color: #cfcfc2;">
                        <h4 style="margin-bottom: 1rem; color: var(--accent-green);">Conclusiones</h4>
                        <ul style="list-style-type: disc; padding-left: 1.5rem; text-align: left;">
                            <li style="margin-bottom: 0.5rem;">
                                El periodo depende de la raíz cuadrada de la masa <span set:html={String.raw`($T \propto \sqrt{m}$)`} /> y es inversamente proporcional a la raíz de la carga y densidad <span set:html={String.raw`($T \propto 1/\sqrt{q\lambda}$)`} />.
                            </li>
                            <li style="margin-bottom: 0.5rem;">
                                A mayor radio {math.R}, mayor es el periodo.
                            </li>
                        </ul>
                    </div>
                </div>
            </StepBox>

            <div style="margin: 2rem 0; text-align: center;">
                <a href="/" style="color: var(--accent-green); text-decoration: none; border: 1px solid var(--accent-green); padding: 0.5rem 1rem; border-radius: 4px; transition: all 0.3s ease; display: inline-block;">
                    &larr; Volver al Problema Anterior
                </a>
            </div>


        </div>
    </div>
</Layout>

<!-- Tooltips -->
<div id="tooltip-radial" class="tooltip-box">{math.radial_tooltip_text}</div>
<div id="tooltip-Lp" class="tooltip-box">{math.step1_Lp_tooltip_text}</div>

<!-- Gauss Tooltip -->
<div id="tooltip-gauss" class="tooltip-box" style="width: 300px; max-width: 300px;">
    <h4 style="margin: 0 0 0.5rem 0; color: var(--accent-green);">Ley de Gauss</h4>
    <p style="margin-bottom: 0.5rem;">Relaciona el flujo eléctrico a través de una superficie cerrada con la carga encerrada.</p>
    <div set:html={math.gauss_tooltip_eq} />
</div>

<!-- Modal -->
<div id="math-modal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close">&times;</span>
        <div id="modal-body-text">
            <!-- Content injected via JS -->
        </div>
    </div>
</div>

<!-- LeaderLine Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leader-line/1.0.7/leader-line.min.js" is:inline></script>

<!-- Interactive Scripts -->
<script is:inline>
    // Tooltip Logic
    document.addEventListener('DOMContentLoaded', () => {
        const tooltipOffset = 15;

        function updatePosition(target, tooltipEl) {
            const rect = target.getBoundingClientRect();
            const scrollY = window.scrollY || window.pageYOffset;
            const scrollX = window.scrollX || window.pageXOffset;

            let top = rect.top + scrollY - tooltipEl.offsetHeight - tooltipOffset;
            let left = rect.left + scrollX + (rect.width / 2) - (tooltipEl.offsetWidth / 2);

            if (left < 10) left = 10;
            if (left + tooltipEl.offsetWidth > window.innerWidth - 10) {
                left = window.innerWidth - tooltipEl.offsetWidth - 10;
            }
            if (top < scrollY) {
                top = rect.bottom + scrollY + tooltipOffset;
            }

            tooltipEl.style.top = `${top}px`;
            tooltipEl.style.left = `${left}px`;
        }

        function showTooltip(target, tooltipId) {
            const tooltip = document.getElementById(tooltipId);
            if (!tooltip) return;

            tooltip.style.display = 'block';
            updatePosition(target, tooltip);

            if (window.MathJax && window.MathJax.typesetPromise) {
                MathJax.typesetPromise([tooltip]).catch(() => { });
            }
        }

        function hideTooltip(tooltipId) {
            const tooltip = document.getElementById(tooltipId);
            if (tooltip) tooltip.style.display = 'none';
        }

        document.body.addEventListener('mouseover', (e) => {
            const trigger = e.target.closest('.hover-trigger');
            if (!trigger) return;

            let tooltipId = trigger.dataset.tooltip;
            if (trigger.classList.contains('radial-tooltip')) {
                tooltipId = 'tooltip-radial';
            }
            if (trigger.classList.contains('Lp-tooltip')) {
                tooltipId = 'tooltip-Lp';
            }

            if (tooltipId) {
                showTooltip(trigger, tooltipId);
                trigger._activeTooltipId = tooltipId;
            }
        });

        document.body.addEventListener('mouseout', (e) => {
            const trigger = e.target.closest('.hover-trigger');
            if (!trigger || !trigger._activeTooltipId) return;

            hideTooltip(trigger._activeTooltipId);
            trigger._activeTooltipId = null;
        });
    });

    // Modal Logic
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('math-modal');
        const closeBtn = document.querySelector('.modal-close');
        const triggers = document.querySelectorAll('.interactive-math');
        const bodyText = document.getElementById('modal-body-text');

        const contentMap = {
            'default': `
                <h3 style="color: var(--accent-green); margin-top: 0;">Detalle Matemático</h3>
                <p>Partimos de la Ley de Gauss general:</p>
                $$ \\oint_S \\vec{E} \\cdot d\\vec{S} = \\frac{\\mathrm{Q}_{\\text{enc}}}{\\varepsilon_0} $$
            `
        };

        if (modal && bodyText) {
            triggers.forEach(trigger => {
                trigger.addEventListener('click', () => {
                    const type = trigger.getAttribute('data-modal') || 'default';
                    bodyText.innerHTML = contentMap[type] || contentMap['default'];
                    if (window.MathJax) {
                        MathJax.typesetPromise ? MathJax.typesetPromise([bodyText]) : MathJax.Hub.Queue(["Typeset", MathJax.Hub, bodyText]);
                    }
                    modal.classList.add('active');
                });
            });

            closeBtn.addEventListener('click', () => modal.classList.remove('active'));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('active');
            });
        }
    });

    // Equation Linking
    document.addEventListener('DOMContentLoaded', () => {
        function safeInit() {
            initEquationLinking();
        }
        if (window.MathJax && window.MathJax.startup) {
            window.MathJax.startup.promise.then(safeInit);
        } else {
            setTimeout(safeInit, 2000);
        }
    });

    function initEquationLinking() {
        const sources = document.getElementsByClassName('math-term-source');
        const targets = document.getElementsByClassName('math-term-target');

        if (sources.length > 0 && targets.length > 0) {
            const source = sources[0];
            const target = targets[0];
            let line = null;

            target.addEventListener('mouseenter', () => {
                if (window.LeaderLine) {
                    line = new LeaderLine(source, target, {
                        color: '#f92672',
                        size: 2,
                        path: 'grid',
                        startSocket: 'right',
                        endSocket: 'right',
                        startPlug: 'disc',
                        endPlug: 'arrow3',
                        dash: { animation: true }
                    });
                }
            });
            const removeLine = () => { if (line) { line.remove(); line = null; } };
            target.addEventListener('mouseleave', removeLine);
            window.addEventListener('scroll', removeLine);
        }

        const sources2 = document.getElementsByClassName('math-term-source-2');
        const targets2 = document.getElementsByClassName('math-term-target-2');

        if (sources2.length > 0 && targets2.length > 0) {
            const source2 = sources2[0];
            const target2 = targets2[0];
            let line2 = null;

            target2.addEventListener('mouseenter', () => {
                if (window.LeaderLine) {
                    line2 = new LeaderLine(source2, target2, {
                        color: '#a6e22e',
                        size: 2,
                        path: 'grid',
                        startSocket: 'bottom',
                        endSocket: 'right',
                        startPlug: 'disc',
                        endPlug: 'arrow3',
                        dash: { animation: true }
                    });
                }
            });
            const removeLine2 = () => { if (line2) { line2.remove(); line2 = null; } };
            target2.addEventListener('mouseleave', removeLine2);
            window.addEventListener('scroll', removeLine2);
        }
    }
</script>
