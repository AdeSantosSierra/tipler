---
import PhysicsProblemTemplate from '../components/master/PhysicsProblemTemplate.astro';
import StepBox from '../components/StepBox.astro';
import { symbols, cylindricalFlux, cylindricalVolumeCharge, cylindricalVolumeFieldMag, cylindricalVectorField, withTooltip } from '../lib/physics-math';

const apartados = [
  { id: 'apartado-a', label: 'Resolución', active: true }
];

const configSolid = encodeURIComponent(JSON.stringify({
  shells: [{ radius: 1.5, color: 0xae81ff, opacity: 0.6, solid: true, label: 'R' }],
  gaussian: { radius: 0.8, visible: true, color: 0xe2d0f8, opacity: 0.28 }
}));

const configSolidOutside = encodeURIComponent(JSON.stringify({
  shells: [{ radius: 1.5, color: 0xae81ff, opacity: 0.6, solid: true, label: 'R' }],
  gaussian: { radius: 2.2, visible: true, color: 0xe2d0f8, opacity: 0.28 }
}));

export const math = {
    rho: symbols.rho,
    R: symbols.R(''),
    r: symbols.r,
    epsilon: symbols.epsilon0,
    lambda: symbols.lambda,
    
    // Detailed Flux Derivation
    flux_derivation: String.raw`
        \oint_S \vec{E} \cdot d\vec{S}
            = \oint_S E \, dS
            = E \oint_S dS
            = E (2\pi r L)`,

    // Inside r < R
    inside_cond: String.raw`${symbols.r} < ${symbols.R('')}`,
    inside_qenc: String.raw`Q_{\text{enc}} = ${cylindricalVolumeCharge(symbols.rho, symbols.r)}`,
    inside_res: cylindricalVectorField(cylindricalVolumeFieldMag(symbols.rho, symbols.R(''), symbols.r, true)),

    // Outside r > R
    outside_cond: String.raw`${symbols.r} > ${symbols.R('')}`,
    outside_qenc: String.raw`Q_{\text{enc}} = ${cylindricalVolumeCharge(symbols.rho, symbols.R(''))}`,
    outside_res: cylindricalVectorField(cylindricalVolumeFieldMag(symbols.rho, symbols.R(''), symbols.r, false)),
    
    // Lambda relation
    lambda_eq: String.raw`${symbols.lambda} = ${symbols.rho} \pi ${symbols.R('')}^2`,
    lambda_res: cylindricalVectorField(String.raw`\frac{${symbols.lambda}}{2 \pi \varepsilon_0 ${symbols.r}}`),

    // Conclusions
    conclusions: String.raw`
        \vec{E}(r) = \begin{cases} 
        ${cylindricalVolumeFieldMag(symbols.rho, symbols.R(''), symbols.r, true)} \, \vec{u}_r & r < R \\
        ${cylindricalVolumeFieldMag(symbols.rho, symbols.R(''), symbols.r, false)} \, \vec{u}_r = \frac{\lambda}{2\pi\varepsilon_0 r} \, \vec{u}_r & r > R
        \end{cases} \quad ${symbols.units}`
};
---

<PhysicsProblemTemplate title="Problema 4: Cilindro Sólido" apartados={apartados}>
    <div slot="header" class="problem-header">
    </div>

    <StepBox slot="statement" label="Enunciado del Problema" vizSrc="/generic_cylindrical_viewer.html?hideGauss=true&config=%7B%22shells%22%3A%5B%7B%22radius%22%3A1.5%2C%22color%22%3A11436543%2C%22opacity%22%3A0.6%2C%22solid%22%3Atrue%2C%22label%22%3A%22R%22%7D%5D%7D" vizId="viz-step-0">
        <div class="step-content">
            <div class="step-text-col" style="flex: 1; border: none; text-align: left; color: white;">
                <p>Un cilindro <strong>no conductor</strong> infinitamente largo de radio $R$ posee una densidad de carga volúmica uniforme {`$ ` + math.rho + ` $`}.</p>
                <p style="margin-top: 1rem;">Demostrar que el campo eléctrico viene dado por:</p>
                <div style="margin: 1.5rem 0; font-size: 1.2rem;">
                  <p set:html={`$$ E_r = \\begin{cases} ${cylindricalVolumeFieldMag(math.rho, math.R, math.r, true)} & r < R \\\\ ${cylindricalVolumeFieldMag(math.rho, math.R, math.r, false)} = \\frac{1}{2\\pi\\varepsilon_0} \\frac{\\lambda}{r} & r > R \\end{cases} $$`} />
                </div>
                <p>donde {`$ ` + math.lambda_eq + ` $`} es la carga por unidad de longitud.</p>
            </div>
        </div>
    </StepBox>

    <div id="apartado-a" class="apartado-section active">
        <StepBox label={String.raw`Cálculo para el interior: $ r < R $`}>
            <div class="step-content-wrapper">
                <div class="step-viz-col">
                    <iframe src={`/generic_cylindrical_viewer.html?config=${configSolid}`} class="viz-frame" id="viz-inside" scrolling="no" style="width: 100%; height: 400px; border: none; border-radius: 8px;"></iframe>
                </div>
                <div class="step-text-math-col" style="padding: 0;">
                    <div class="paso2-section">
                        <div class="paso2-comment">
                            <p>Evaluamos el flujo a través de la superficie gaussiana. Por simetría, el campo es radial y constante en la superficie lateral.</p>
                        </div>
                        <div class="paso2-math">
                            <div style="font-size: 1.05em; overflow-x: auto;" set:html={String.raw`$$ \begin{align*} ${math.flux_derivation} \end{align*} $$`} />
                        </div>
                    </div>

                    <div class="paso2-section">
                        <div class="paso2-comment">
                            <p>La carga encerrada es el producto de la densidad uniforme {`$ ` + math.rho + ` $`} por el volumen encerrado.</p>
                        </div>
                        <div class="paso2-math">
                            <div style="font-size: 1.05em; overflow-x: auto;" set:html={`$$ ${math.inside_qenc} $$`} />
                        </div>
                    </div>

                    <div class="paso2-section" style="border-bottom: none;">
                        <div class="paso2-comment">
                            <p>Igualamos según la Ley de Gauss y despejamos el campo eléctrico vectorial.</p>
                        </div>
                        <div class="paso2-math">
                            <div style="font-size: 1.05em; overflow-x: auto;" set:html={String.raw`$$ \begin{align*} ${math.inside_res} \end{align*} $$`} />
                        </div>
                    </div>
                </div>
            </div>
        </StepBox>

        <StepBox label={String.raw`Cálculo para el exterior: $ r > R $`}>
            <div class="step-content-wrapper">
                <div class="step-viz-col">
                    <iframe src={`/generic_cylindrical_viewer.html?config=${configSolidOutside}`} class="viz-frame" id="viz-outside" scrolling="no" style="width: 100%; height: 400px; border: none; border-radius: 8px;"></iframe>
                </div>
                <div class="step-text-math-col" style="padding: 0;">
                    <div class="paso2-section">
                        <div class="paso2-comment">
                            <p>Para $ r > R $, la superficie gaussiana encierra toda la carga del cilindro de radio $R$.</p>
                        </div>
                        <div class="paso2-math">
                            <div style="font-size: 1.05em; overflow-x: auto;" set:html={`$$ ${math.outside_qenc} $$`} />
                        </div>
                    </div>

                    <div class="paso2-section">
                        <div class="paso2-comment">
                            <p>El flujo es idéntico al cálculo anterior. Obtenemos el campo exterior:</p>
                        </div>
                        <div class="paso2-math">
                            <div style="font-size: 1.05em; overflow-x: auto;" set:html={String.raw`$$ \begin{align*} ${math.outside_res} \end{align*} $$`} />
                        </div>
                    </div>

                    <div class="paso2-section" style="border-bottom: none;">
                        <div class="paso2-comment">
                            <p>Finalmente, sustituimos {`$ ` + math.rho + ` $`} por la carga lineal {`$ ` + math.lambda + ` $`} para obtener la expresión solicitada.</p>
                        </div>
                        <div class="paso2-math">
                            <div style="font-size: 1.05em; overflow-x: auto;" set:html={String.raw`$$ \begin{align*} ${math.lambda_res} \end{align*} $$`} />
                        </div>
                    </div>
                </div>
            </div>
        </StepBox>

        <StepBox label="Conclusiones y Resultados Finales">
            <div class="step-content-wrapper">
                <div class="step-text-math-col" style="padding: 0;">
                    <div class="paso2-section" style="border-bottom: none;">
                        <div class="paso2-comment" style="color: #f8f8f2;">
                            <p>Resumen del campo eléctrico del cilindro infinito cargado:</p>
                        </div>
                        <div class="paso2-math">
                            <div style="font-size: 1.4em; color: white;" set:html={String.raw`$$ ${math.conclusions} $$`} />
                        </div>
                    </div>
                </div>
            </div>
        </StepBox>
    </div>
</PhysicsProblemTemplate>
