---
import Layout from '../../layouts/Layout.astro';

interface Apartado {
  id: string;
  label: string;
  active?: boolean;
}

interface Props {
  title: string;
  apartados?: Apartado[];
}

const { title, apartados = [] } = Astro.props;
---

<Layout title={title}>
    <div class="main-layout">
        <slot name="header" />

        <slot name="statement" />

        {apartados.length > 0 && (
          <div class="apartados-nav">
              {apartados.map(tab => (
                <button 
                  class={`apartado-tab ${tab.active ? 'active' : ''}`} 
                  data-target={tab.id}
                >
                  {tab.label}
                </button>
              ))}
          </div>
        )}

        <div class="apartados-content">
            <slot />
        </div>
    </div>

    <!-- Navigation Menu Button -->
    <button id="menu-button" class="menu-button" aria-label="Menú de navegación">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>

    <!-- Navigation Modal -->
    <div id="nav-modal" class="modal-overlay">
        <div class="modal-content nav-modal-content">
            <span class="modal-close nav-modal-close">&times;</span>
            <h3 style="color: #e6db74; margin-top: 0; margin-bottom: 1.5rem;">Problemas Disponibles</h3>
            <div class="nav-options">
                <a href="/" class="nav-option">Problema 1: Barra Cargada</a>
                <a href="/problema_orbita" class="nav-option">Problema 2: Órbita con Carga</a>
                <a href="/problema_cortezas" class="nav-option">Problema 3: Cortezas Cilíndricas</a>
                <a href="/problema_cilindro_solido" class="nav-option">Problema 4: Cilindro Sólido</a>
            </div>
        </div>
    </div>
</Layout>

<div id="math-global-tooltip"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leader-line/1.0.7/leader-line.min.js" is:inline></script>

<style is:global>
    .apartados-nav {
        display: flex;
        gap: 1rem;
        margin: 2rem 0;
        justify-content: center;
    }

    .apartado-tab {
        background-color: #3e3d32;
        border: 1px solid #75715e;
        color: #f8f8f2;
        padding: 0.8rem 1.5rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s ease;
    }

    .apartado-tab:hover {
        background-color: #4e4d42;
        border-color: #e6db74;
    }

    .apartado-tab.active {
        background-color: #e6db74;
        color: #272822;
        border-color: #e6db74;
        font-weight: bold;
    }

    .apartado-section {
        display: none !important;
    }

    .apartado-section.active {
        display: block !important;
    }

    .derivation-row {
        display: flex; 
        align-items: center; 
        margin-bottom: 3rem; 
        gap: 0;
    }

    .derivation-col-left {
        flex: 1; 
        color: #cfcfc2; 
        font-size: 1.05rem; 
        line-height: 1.6;
        padding-right: 2.5rem;
        border-right: 1px dashed #75715e;
        height: 100%;
        display: flex;
        align-items: center;
    }

    .derivation-col-right {
        flex: 1; 
        display: flex; 
        justify-content: center; 
        padding-left: 2.5rem;
        position: relative;
    }

    .numerador-tooltip-container {
        position: relative;
        display: inline-block;
        width: 100%;
    }

    .flux-hover, .flux-box-target, .math-term-target, .math-term-target-flujo-B, .numerador-tooltip-target {
        border: 1.5px dashed #f92672;
        border-radius: 4px;
        padding: 2px 6px;
        background: rgba(249, 38, 114, 0.08); 
        cursor: help;
        transition: all 0.2s ease;
        display: inline-block;
    }

    .numerador-tooltip-content {
        visibility: hidden;
        opacity: 0;
        position: absolute;
        bottom: calc(100% + 15px);
        left: 50%;
        transform: translateX(-50%);
        width: 280px;
        background: #1e1e1a;
        border: 2px solid #f92672;
        border-radius: 6px;
        padding: 0.8rem 1rem;
        color: #f8f8f2;
        font-size: 0.9rem;
        line-height: 1.5;
        text-align: center;
        transition: all 0.2s ease;
        z-index: 100;
        pointer-events: none;
        box-shadow: 0 8px 20px rgba(0,0,0,0.6);
    }

    .numerador-tooltip-container:hover .numerador-tooltip-content {
        visibility: visible;
        opacity: 1;
        bottom: calc(100% + 10px);
    }

    .qenc-tooltip-container {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
    }

    .qenc-red-box-centered, .qenc-red-box-simple {
        display: inline-flex;
        align-items: center;
        border: 1.5px dashed #f92672;
        border-radius: 4px;
        padding: 0.6rem 1.2rem;
        background: rgba(249, 38, 114, 0.08);
        color: #f8f8f2;
        cursor: help;
        position: relative;
    }

    .qenc-red-box-simple {
      padding: 0.3rem 0.6rem;
    }

    .qenc-tooltip-content {
        visibility: hidden;
        opacity: 0;
        position: absolute;
        bottom: calc(100% + 12px);
        left: 50%;
        transform: translateX(-50%);
        width: 300px;
        background: #1e1e1a;
        border: 1.5px solid #f92672;
        border-radius: 6px;
        padding: 0.8rem 1rem;
        color: #cfcfc2;
        font-size: 0.85em;
        line-height: 1.5;
        transition: all 0.2s ease;
        z-index: 100;
        pointer-events: none;
    }

    .qenc-red-box-centered:hover .qenc-tooltip-content,
    .qenc-red-box-simple:hover .qenc-tooltip-content {
        visibility: visible;
        opacity: 1;
        bottom: calc(100% + 8px);
    }

    .paso2-section {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 0;
        margin-bottom: 0;
        align-items: stretch;
    }

    .paso2-comment {
        color: #cfcfc2;
        font-size: 0.95em;
        line-height: 1.6;
        padding: 1.2rem 2.5rem 1.2rem 0;
        border-right: 1px dashed #75715e;
        text-align: right;
        display: flex;
        align-items: flex-start;
        justify-content: flex-end;
    }

    .paso2-math {
        padding: 1.2rem 2rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    #math-global-tooltip {
        position: fixed;
        visibility: hidden;
        opacity: 0;
        background: #1e1e1a;
        border: 1.5px solid #a6e22e;
        border-radius: 6px;
        padding: 0.6rem 0.8rem;
        color: #cfcfc2;
        font-size: 0.85em;
        z-index: 10001;
        pointer-events: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        transition: opacity 0.2s ease;
        max-width: 250px;
    }
    
    #math-global-tooltip.active {
        visibility: visible;
        opacity: 1;
    }

    /* Menu Button */
    .menu-button {
        position: fixed;
        top: 20px;
        left: calc(50% - 600px - 70px);
        width: 50px;
        height: 50px;
        background-color: #e6db74;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    @media (max-width: 1400px) {
        .menu-button {
            left: 20px;
        }
    }

    .menu-button:hover {
        background-color: #f4e98a;
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
    }

    .menu-button svg {
        color: #272822;
    }

    /* Navigation Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background-color: #3e3d32;
        border: 1px solid #e6db74;
        padding: 2rem;
        border-radius: 8px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        position: relative;
    }

    .modal-close {
        position: absolute;
        top: 10px;
        right: 15px;
        color: #ccc;
        font-size: 1.5rem;
        cursor: pointer;
        font-weight: bold;
    }

    .modal-close:hover {
        color: #f92672;
    }

    .nav-options {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .nav-option {
        background-color: #3e3d32;
        border: 1px solid #75715e;
        color: #f8f8f2;
        padding: 1rem 1.5rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s ease;
        text-align: left;
        text-decoration: none;
    }

    .nav-option:hover {
        background-color: #4e4d42;
        border-color: #e6db74;
        transform: translateX(5px);
    }
</style>

<script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
        const tabs = document.querySelectorAll('.apartado-tab');
        const sections = document.querySelectorAll('.apartado-section');

        // Tab Switching Logic
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const target = tab.dataset.target;
                tabs.forEach(t => t.classList.remove('active'));
                sections.forEach(s => s.classList.remove('active'));
                tab.classList.add('active');
                const targetEl = document.getElementById(target);
                if (targetEl) targetEl.classList.add('active');
                
                // Refresh LeaderLine if any
                window.dispatchEvent(new Event('resize'));
            });
        });

        // Global Math Tooltip Logic
        const globalTooltip = document.getElementById('math-global-tooltip');
        window.showGlobalTooltip = (e, text) => {
            if (!globalTooltip) return;
            globalTooltip.innerHTML = text;
            globalTooltip.classList.add('active');
            updateTooltipPos(e);
        };
        
        window.hideGlobalTooltip = () => {
            if (!globalTooltip) return;
            globalTooltip.classList.remove('active');
        };
        
        function updateTooltipPos(e) {
            if (!globalTooltip || !globalTooltip.classList.contains('active')) return;
            globalTooltip.style.left = `${e.clientX + 15}px`;
            globalTooltip.style.top = `${e.clientY - 20}px`;
        }

        document.addEventListener('mousemove', updateTooltipPos);

        // Navigation Modal Logic
        const navModal = document.getElementById('nav-modal');
        const menuButton = document.getElementById('menu-button');
        const navCloseBtn = document.querySelector('.nav-modal-close');
        
        if (menuButton && navModal) {
            menuButton.addEventListener('click', () => navModal.classList.add('active'));
            navCloseBtn.addEventListener('click', () => navModal.classList.remove('active'));
            navModal.addEventListener('click', (e) => {
                if (e.target === navModal) navModal.classList.remove('active');
            });
        }
    });
</script>
